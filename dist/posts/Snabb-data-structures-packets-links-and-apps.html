<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snabb data structures: packets, links, and apps</title>
    <meta name="description" content="">
    <meta name="author" content="Hrishikesh Barman">

    <link href="/assets/main.css" rel="stylesheet">

  <script>
  window.blogInfo = {
          pageType: 'post',
          postId: 11,
          comment_system: "github"
  };
  </script>

  </head>

  <body class="">
<nav class="nav">
  <div class="nav-left"></div>
  <div class="nav-center">
  <a class="nav-item title is-5" href="/">
    geekodour's blog
  </a>
  </div>
  <span id="nav-toggle" class="nav-toggle">
  <span></span>
  <span></span>
  <span></span>
  </span>
  <div id="nav-menu" class="nav-right nav-menu">
  <a class="nav-item" href="">projects</a>
  <a class="nav-item" href="">favorites</a>
  <a class="nav-item" href="">contact</a>
  </div>
</nav>

      <div class="container">
  <div class="columns">
          <div class="column">
            <div class="section">
<div class="">
  <ul>
  </ul>
</div>
            </div>
          </div>
          <div class="column is-half">
<div class="section">
  <div class="container">
    <div class="content">
      <h1>Snabb data structures: packets, links, and apps</h1>
      <p>Software architectures can sometimes be summarized with a few key data structures.</p>
<p>Unix is about processes, pipes, and files. Processes are executing code, pipes are FIFO byte buffers, and files are binary storage.</p>
<p>Emacs is about text, buffers, and windows. Text is strings of characters with key-value properties, buffers are collections of text and positional markers, and windows are user-visible screen areas that display parts of buffers.</p>
<p>Snabb Switch is about <strong>packets</strong>, <strong>links</strong>, and <strong>apps</strong>.</p>
<p>(This post follows on from #10 <em>Snabb Switch In a Nutshell</em> and assumes that you already have the &quot;app network&quot; picture in your head.)</p>
<h3 id="packets">Packets</h3>
<p>Packets are the basic inputs and outputs of Snabb Switch. A packet is simply a variable-size array of binary data. Packets usually contain data in an Ethernet-based format but this is only a convention.</p>
<pre><code>struct packet {
  unsigned char payload[10240];
  uint16_t length;
}
</code></pre><p>Packets on the wire in physical networks are bits encoded as a series of electrical or optical impulses. Snabb Switch just encodes those same bits into memory. (We <a href="https://groups.google.com/d/msg/snabb-devel/8P7U3a55hVQ/_GAs3XPdLNcJ">resist the temptation of more complicated representations</a>.) Code references: <a href="https://github.com/SnabbCo/snabbswitch/blob/master/src/core/packet.h">packet.h</a> and <a href="https://github.com/SnabbCo/snabbswitch/blob/master/src/core/packet.lua">packet.lua</a>.</p>
<h3 id="links">Links</h3>
<p>A link collects a series of packets for processing by an app. Links between apps serve a similar purpose to ethernet cables between network devices, except that links are unidirectional. Links are represented as simple <a href="https://en.wikipedia.org/wiki/Circular_buffer">ring buffers</a> of packets.</p>
<pre><code>struct link {
  struct packet *packets[256];
  int read, write; // ring cursor positions
}
</code></pre><p>Actually this is a slightly idealized view of the link. The real link struct also includes some counters that are incremented when packets are added, removed, or dropped because no space is available. I suspect we will transition to this simpler representation over time and that is why I show it here. Code refs: <a href="https://github.com/SnabbCo/snabbswitch/blob/master/src/core/link.h">link.h</a> and <a href="https://github.com/SnabbCo/snabbswitch/blob/master/src/core/link.lua">link.lua</a>.</p>
<h3 id="apps">Apps</h3>
<p>Apps are the active part of Snabb Switch. Each app performs either or both of these functions:</p>
<ol>
<li>&quot;Pull&quot; new packets into Snabb Switch by receiving data from the outside world (e.g. a network interface card) and placing them onto output links for processing.</li>
<li>&quot;Push&quot; existing packets from input links through the next step of their processing: output onto a real network, transfer onto one or more output links for processing by other apps, perform filtering or transformation, and so on.</li>
</ol>
<p>In principle an app is a piece of machine code: anything that can execute. In practice an app is represented as a Lua object and executes code compiled by LuaJIT. (This code can easily call out to C, assembler, or other languages but in practice it seldom does.)</p>
<pre><code>{
  input  = { ... },     -- Table of named input links
  output = { ... },     -- Table of named output links
  pull   = &lt;function&gt;,  -- Function to &quot;pull&quot; new packets into the system.
  push   = &lt;function&gt;   -- Function to &quot;push&quot; existing packets onward.
}
</code></pre><p>Code reference: simple examples in <a href="https://github.com/SnabbCo/snabbswitch/blob/master/src/apps/basic/">basic_apps</a>.</p>
<h3 id="summary">Summary</h3>
<p>Those are the most important data structures in Snabb Switch. To do serious Snabb Switch development you only need to write some code that manipulates packets and links. Usually we write apps in Lua using some common libraries, but you can realistically write them from scratch in Lua, C, assembler, or anything else you care to link in.</p>
<p>There are more details of course: we will dig into those later.</p>

    </div>
  </div>
</div>
<div class="section">
  <div class="container">
          <div id="comments_container"></div>
          <div id="loadmore_container" class="has-text-centered"></div>
  </div>
</div>
          </div>
          <div class="column">
            <div class="section">
<div class="">
Hello, welcome to my blog
Here we have fun
</div>
            </div>
          </div>
  </div>
      </div>

      <script src="/assets/prism.js"></script>
      <script src="/assets/main.js"></script>
  </body>
</html>
